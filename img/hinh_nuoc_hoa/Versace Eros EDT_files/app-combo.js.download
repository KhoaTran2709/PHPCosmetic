(function($){
	comboApp = {
		checkCombo: false,
		init: function(idProduct, idTitle){
			var self = this;
			if(typeof idProduct != 'undefined' && idProduct != '' && idProduct != null ){
				self.comboCall('GET', 'https://combo-omni.haravan.com/js/list_recommendeds?product_id=' + idProduct, {}, function(data){
					// success
					if(data.length > 0){
						self.checkCombo = true;
						self.comboRender(data, idProduct, idTitle);
						$('#combo-popup').removeClass('hidden');
						$('.combo-product[data-pid="'+idProduct+'"]').addClass('hidden');
					}
				}, function(){
					//error
				}, function(){
					//always
				});
			}
		},
		comboCall: function(method, path, data, successcallback, errorcallback, alwayscallback){
			var xhr = new XMLHttpRequest();
			xhr.open(method, path);
			xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
			xhr.onload = function () {
				if (xhr.readyState === 4 && xhr.status === 200) {
					if (Object.prototype.toString.call(successcallback) === '[object Function]') successcallback(JSON.parse(xhr.responseText));
				}
				else {
					if (Object.prototype.toString.call(errorcallback) === '[object Function]') errorcallback();
				}
			};
			xhr.onloadend = function () {
				if (Object.prototype.toString.call(alwayscallback) === '[object Function]') alwayscallback();
			};
			xhr.send(data);
		},
		comboRender: function(result, id, title){
			var giftHtml = '';
			var titleHtml = '';
			$.each(result, function(key, value){
				var noti = '';
				var itemCombo = '';
				$.each(value.recommendeds, function(i,v){
					noti += '<span> <b>'+v.quantity +'</b></span><span> '+ (v.product_name).split('|')[0]+'</span> +';
				});
				$.each(value.recommendeds, function(i,v){

					var typeHtml = '';
					var xprice = 0;
					var imm = "https://hstatic.net/0/0/global/noDefaultImage6_large.gif";
					var variant = null;
					var pid = null;
					var is_none_promotion = v.none_promotion;
					var is_apply_variant = v.is_apply_by_variant;//Thêm 
					var valuePromotion=v.promotion_value;
					var typePromotion=v.type;
					var name = v.product_name;
					var url= v.product_url;
					$.ajax({
						type: 'GET',
						url: v.product_url+'.js',
						dataType: 'json',
						async: false,
						success:function(response){
							xprice = parseInt(response.price)/100;
							imm = (response.featured_image != null)?Haravan.resizeImage(response.featured_image, 'small'):'https://hstatic.net/0/0/global/noDefaultImage6_large.gif';
							variant = is_apply_variant?v.apply_productvariants[0].id :response.variants[0].id; //Fix
							pid = response.id;
							if(is_apply_variant){

								$.each(v.apply_productvariants,function(i,v){
									var html_variant='';
									var apply_qty = v.qty;
									var type_pro_variant = v.type;
									var value_pro_variant = v.promotion_value;
									var variant_apply = v.id;
									$.each(response.variants,function(i,v){
										if(variant_apply == v.id){
											var xprice_variant = parseInt(v.price)/100;
											var fixedPrice_variant = 0;
											var product_id = v.id;
											if(is_none_promotion == false){
												if(type_pro_variant === 1 ){
													var fixedPrice_variant = xprice_variant - value_pro_variant;
												}
												else{
													if(type_pro_variant == 4){
														fixedPrice = value_pro_variant;
													}
													else{
														var fixedPrice_variant = (xprice_variant*(100-value_pro_variant))/100;
													}
												}
												if(fixedPrice_variant == xprice_variant){
													html_variant += "<p><b><a href='"+url+"'>"+ name.split('|')[0] + "</a></b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice_variant).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b></p>";
												}
												else{

													html_variant += "<p><b><a href='"+url+"'>"+ name.split('|')[0] + "</a></b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice_variant).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b><del>"+(xprice_variant).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</del></p>";
												}
											}
											else{
												var fixedPrice_variant = xprice_variant;
												html_variant += "<p><b>"+ name.split('|')[0] + "</b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice_variant).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b></p>";
											}
											var html = '<tr haravan-promotion><td><label class="combo-product" data-pid="'+pid+'" data-countbuy="'+apply_qty+'" data-id="'+product_id+'"><img class="combo-img" src="'+imm+'"><p>'+html_variant+'</p></label></td></tr>';
											itemCombo += html;
										}
									})
								})

							}
						}
					});
					if(is_apply_variant == false){
						if(is_none_promotion == false){
							if(typePromotion === 1 ){
								var fixedPrice = xprice - valuePromotion;
							}
							else{
								if(typePromotion == 4){
									fixedPrice = valuePromotion;
								}
								else{
									var fixedPrice = (xprice*(100-valuePromotion))/100;
								}
							}
							if(fixedPrice == xprice){
								typeHtml += "<p><b><a href='"+url+"'>"+ name.split('|')[0] + "</a></b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b></p>";
							}
							else{
								typeHtml += "<p><b><a href='"+url+"'>"+ name.split('|')[0] + "</a></b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b><del>"+(xprice).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</del></p>";
							}
						}
						else{
							var fixedPrice = xprice;
							typeHtml += "<p><b>"+ (v.product_name).split('|')[0] + "</b></p><p class='discount-promotion-price'><label>Trị giá: </label><b>"+(fixedPrice).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "₫"+"</b></p>";
						}
						var html = '<tr haravan-promotion><td><label class="combo-product" data-pid="'+pid+'" data-countbuy="'+v.quantity+'" data-id="'+variant+'"><img class="combo-img" src="'+imm+'"><p>'+typeHtml+'</p></label></td></tr>';
						itemCombo += html;
					}
				});
				giftHtml += "<div class='combo-w "+((key==0)?'checked':'')+"'><p class='name-combo'><span>"+value.name_combo+"</span></p><div class='combo-list'><table>"+itemCombo+"</table></div></div>";
				titleHtml = "<p class='name-combo'>Combo</p>";
			});
			$('#combo-popup #combo-program').html(giftHtml);
			$('#combo-popup .heading-combo').html(titleHtml);
		},
		comboAddCart: function(pid, vid, callback){
			var self = this;
			var data = [];
			$('#combo-program .combo-w.checked .combo-product').each(function(k, e){
				/*	if(parseInt($(this).attr('data-pid')) == pid){
					data[k] = {"vid": vid, "quan": parseInt($(this).attr("data-countbuy"))};
				}else{
					data[k] = {"vid": $(this).attr('data-id'), "quan": parseInt($(this).attr("data-countbuy"))};
				}*/
				data[k] = {"vid": $(this).attr('data-id'), "quan": parseInt($(this).attr("data-countbuy"))};
			});
			var success = 0;
			$.each(data, function(index, value){
				var params = {quantity:value.quan,id:value.vid};
				jQuery.ajax({
					type: 'POST',
					url: '/cart/add.js',
					data: params,
					dataType: 'json',
					async: false,
					success: function(cart) {
						success = index;
					},
					error: function(XMLHttpRequest, textStatus) {
						Haravan.onError(XMLHttpRequest, textStatus);
					}
				});
			});
			if((success+1) == data.length){
				callback(true);
			}else{
				callback(false);
			}
		},
		comboUpdateCart: function(){
			var self = this;
			var listCart = document.querySelectorAll('[id^="updates_"]');
			var tmp  = "";
			var listVariantIdHasPromotion = [];
			var listPromotionIdExisted = [];
			for(var i = 0; i < listCart.length; i++) {
				var qty = parseInt(listCart[i].value);
				if(i > 0) tmp += "&";
				tmp += "updates[]=" + qty;
			}
			tmp += "&note="+$('#note').val();
			$.post('/cart', tmp).always(function() {

				setTimeout(function() { location.reload(); }, 500);
			});
		}
	}
	$(document).ready(function (){
		var idProduct = $('#combo-program').data('id');
		var idTitle = $('#combo-program').data('title');
		comboApp.init(idProduct, idTitle);

		$('body').on('click', '.combo-w', function(e){
			$('.combo-w').removeClass('checked');
			$(this).addClass('checked');
		})
	})
})(jQuery)